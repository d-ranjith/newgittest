Revised Design Document: Email Notification System
1. Introduction
This system enables support users to trigger email notifications for a given corpid (customer organization ID) and application name. The system processes user emails, applies a template, and sends notifications via email. The process is optimized for scalability and includes efficient handling of large batches (e.g., 2000+ users) using Kafka and parallel processing.

2. Components
API Gateway (Swagger-defined API)
Kafka (For asynchronous processing and scalability)
S3 (For storing email templates)
MongoDB (For tracking status of email notifications)
Email Sending Service (Responsible for sending emails using SMTP or API)
3. Workflow Overview
Support User Input: The support user provides a corpid and application name. The requestId is internally generated by the API to uniquely identify the request.

Template Storage in S3: A .tpl template file is stored in an S3 bucket. The URL of this template is provided to the API.

Request Processing:

The API receives a request with corpid and application name.
The API validates these inputs and fetches a list of user emails from the database.
The API enqueues the user email list and the S3 URL of the template into Kafka for processing.
Kafka Consumer:

The Kafka consumer receives the email list and template URL, processes the emails, applies the template, and sends out notifications.
After sending, the consumer updates MongoDB with the status of each email notification (Sent, Failed, etc.) and the time it was sent.
Email Status: The API provides an endpoint to check the status of sent emails for a given requestId.

4. Database Schema
MongoDB Collections:
Email Status Collection: This collection will store the status of each email sent for a specific requestId.

Document Example:

json
Copy
Edit
{
  "_id": "ObjectId('...')",
  "requestId": "123e4567-e89b-12d3-a456-426614174000",
  "email": "user@example.com",
  "status": "Sent",
  "sentAt": "2025-02-05T13:00:00Z"
}
Email Request Collection: This collection will store metadata regarding the request, including the corpid, application name, and the list of emails that were processed.

Document Example:

json
Copy
Edit
{
  "_id": "ObjectId('...')",
  "requestId": "123e4567-e89b-12d3-a456-426614174000",
  "corpid": "ABC123",
  "application": "Payroll",
  "tplFileUrl": "https://your-bucket-name.s3.amazonaws.com/notification.tpl",
  "users": [
    { "email": "user1@example.com" },
    { "email": "user2@example.com" }
  ],
  "status": "Processing",
  "createdAt": "2025-02-05T12:00:00Z"
}
5. API Endpoints
1. Trigger Email Notification
Endpoint: POST /email-notifications

This endpoint is used to trigger the email notification process by sending the corpid and application name. The requestId is internally generated.

Request Body:

json
Copy
Edit
{
  "corpid": "ABC123",
  "application": "Payroll",
  "tplFileUrl": "https://your-bucket-name.s3.amazonaws.com/notification.tpl",
  "users": [
    { "email": "user1@example.com" },
    { "email": "user2@example.com" }
  ]
}
Response:

json
Copy
Edit
{
  "status": "success",
  "message": "Email notification process triggered successfully.",
  "requestId": "123e4567-e89b-12d3-a456-426614174000"
}
Possible Errors:

400 Bad Request: Invalid corpid, application name, or email addresses.
401 Unauthorized: User does not have the required authorization.
500 Internal Server Error: Failure in processing the request.
2. Get Email Status
Endpoint: GET /email-notifications/{requestId}/status

This endpoint allows users to check the status of the email notifications for a given requestId.

Request Parameters:

requestId: The unique identifier for the email notification request.
Response:

json
Copy
Edit
{
  "requestId": "123e4567-e89b-12d3-a456-426614174000",
  "status": "Completed",
  "users": [
    {
      "email": "user1@example.com",
      "status": "Sent",
      "sentAt": "2025-02-05T13:00:00Z"
    },
    {
      "email": "user2@example.com",
      "status": "Failed",
      "sentAt": "2025-02-05T13:02:00Z"
    }
  ]
}
Possible Errors:

400 Bad Request: Invalid requestId.
404 Not Found: No records found for the given requestId.
500 Internal Server Error: General error in fetching email statuses.
3. Retry Email Notifications
Endpoint: POST /email-notifications/{requestId}/retry

This endpoint allows support users to retry sending emails for a specific requestId where the status is Failed.

Request Parameters:

requestId: The unique identifier for the email notification request.
Response:

json
Copy
Edit
{
  "status": "success",
  "message": "Email notification retry triggered successfully.",
  "requestId": "123e4567-e89b-12d3-a456-426614174000"
}
Possible Errors:

400 Bad Request: Invalid requestId.
404 Not Found: No failed email notifications found for the given requestId.
500 Internal Server Error: General error in retry processing.
4. Get Template File Information
Endpoint: GET /email-notifications/template

This endpoint retrieves metadata about a specific template stored in the S3 bucket.

Request Parameters:

tplFileUrl: URL pointing to the .tpl file stored in S3.
Response:

json
Copy
Edit
{
  "tplFileUrl": "https://your-bucket-name.s3.amazonaws.com/notification.tpl",
  "templateSize": "3KB",
  "lastModified": "2025-02-05T12:00:00Z"
}
Possible Errors:

400 Bad Request: Invalid tplFileUrl.
404 Not Found: Template not found at the specified URL.
500 Internal Server Error: Error in fetching template metadata.
6. Authentication and Authorization
OAuth 2.0 will be used for securing all API endpoints.
Only support users with valid roles can trigger email notifications and view statuses.
OAuth tokens will be validated in the Authorization header for every API call.
7. Parallel Processing and Scalability
Kafka Consumers: Kafka will be used for parallel processing. Each consumer will process email batches concurrently to ensure scalability when handling large lists of emails (e.g., 2000+).
Batch Size Control: Kafka consumers will process email batches in parallel, using adjustable batch sizes for efficient processing.
Retries and Failures: If email sending fails, the Kafka consumer will retry sending the email based on predefined retries logic. The failure status will be logged in MongoDB.
8. Swagger API Specification Example
yaml
Copy
Edit
openapi: 3.0.0
info:
  title: Email Notification Service API
  description: API to trigger and track email notifications using templates.
  version: 1.0.0
paths:
  /email-notifications:
    post:
      summary: Trigger email notification process
      requestBody:
        description: Request body to trigger email notifications
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                corpid:
                  type: string
                application:
                  type: string
                tplFileUrl:
                  type: string
                users:
                  type: array
                  items:
                    type: object
                    properties:
                      email:
                        type: string
      responses:
        '200':
          description: Email notification process triggered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
                  requestId:
                    type: string
        '400':
          description: Invalid input or bad request
        '500':
          description: Internal server error
  /email-notifications/{requestId}/status:
    get:
      summary: Get the status of email notifications for a specific requestId
      parameters:
        - in: path
          name: requestId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Status of email notifications
          content:
            application/json:
              schema:
                type: object
                properties:
                  requestId:
                    type: string
                  status:
                    type: string
                  users:
                    type: array
                    items:
                      type: object
                      properties:
                        email:
                          type: string
                        status:
                          type: string
                        sentAt:
                          type: string
                          format: date-time
        '400':
          description: Invalid requestId
        '404':
          description: No records found
        '500':
          description: Internal server error
  /email-notifications/template:
    get:
      summary: Get template file information
      parameters:
        - in: query
          name: tplFileUrl
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Template file metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  tplFileUrl:
                    type: string
                  templateSize:
                    type: string
                  lastModified:
                    type: string
                    format: date-time
        '400':
          description: Invalid tplFileUrl
        '404':
          description: Template not found
        '500':
          description
