# Run the Snyk scan, capture the output, and display it on the console
snyk_output=$(snyk scan your-project | tee snyk_report.txt)

# Capture the exit code
exit_code=$?

# Initialize a variable to count vulnerabilities
vulnerability_count=0

if [ $exit_code -eq 0 ]; then
    result='{"status": "success", "message": "Snyk scan was successful; no vulnerabilities found.", "exit_code": '$exit_code', "vulnerability_count": '$vulnerability_count'}'
else
    # Snyk scan failed; vulnerabilities found.
    # Extract the vulnerability count from the Snyk output.
    vulnerability_count=$(grep -c "Vulnerability ID:" snyk_report.txt)
    result='{"status": "failure", "message": "Snyk scan failed; '$vulnerability_count' vulnerabilities found.", "exit_code": '$exit_code', "vulnerability_count": '$vulnerability_count', "details": '$snyk_output'}'
fi

# Output the JSON blob
echo $result

# Clean up: Remove the text file
rm snyk_report.txt
