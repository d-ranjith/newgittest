#!/bin/bash

# Directory containing Tekton task YAML files
TASK_DIR="/path/to/tekton/tasks"

# Create a directory to store extracted scripts
SCRIPT_DIR="/path/to/extracted/scripts"
mkdir -p "$SCRIPT_DIR"

# Create a temporary directory to store updated YAML files
TMP_DIR=$(mktemp -d)

# Loop through each YAML file
for file in "$TASK_DIR"/*.yaml; do
    # Extract inline scripts
    awk '/^script: \|$/,/:$/{print "  script: '"$SCRIPT_DIR/$(basename "$file" .yaml)_script_"++c".sh"'";next} {print}' "$file" > "$TMP_DIR/$(basename "$file")_updated.yaml"
    awk '/^script: \|$/,/:$/{print > "'"$SCRIPT_DIR/$(basename "$file" .yaml)_script_"c".sh"'";next} 1' "$file"
    # Replace inline scripts with references to external script files
    # Update the YAML file with the correct paths to external script files
    # Save the updated YAML file to the temporary directory
    awk '/^script: \|$/,/:$/{print "  script: '"$SCRIPT_DIR/$(basename "$file" .yaml)_script_"++c".sh"'";next} {print}' "$file" > "$TMP_DIR/$(basename "$file")_updated.yaml"
done

# Calculate file size difference in MB
original_size=$(du -shb "$TASK_DIR" | awk '{sum += $1} END {print sum/1024/1024}')
updated_size=$(du -shb "$TMP_DIR" | awk '{sum += $1} END {print sum/1024/1024}')
size_difference=$(echo "$updated_size - $original_size" | bc)

echo "Total size difference for all files: $size_difference MB"

# Replace original YAML files with the updated ones
mv "$TMP_DIR"/*.yaml "$TASK_DIR"

# Cleanup temporary directory
rm -rf "$TMP_DIR"
